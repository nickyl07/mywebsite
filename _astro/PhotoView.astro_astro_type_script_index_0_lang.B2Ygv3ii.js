class m extends HTMLElement{#y=!1;#e=this.dataset.layout==="masonry";#M=this.dataset.masonryStrategy||"sequential";#r=parseInt(this.dataset.gap||"16",10);#x=parseInt(this.dataset.minPhotoWidth||"240",10);#C=parseInt(this.dataset.maxPhotoWidth||"1000",10);#u=parseInt(this.dataset.batchSize||"15",10);#h=0;#s=0;#p=0;#i=[];#l=0;#o=!1;#m=!1;#f=[];#g=!1;#q=window.innerHeight*.6;#n=null;#t=null;#c=null;#d=null;#a=null;async connectedCallback(){this.#y||(this.#y=!0,this.#t=this.querySelector(".photo-container"),this.#n=document.querySelector(".photo-loader"),await this.#A(),this.#T(),this.#b(),this.#w(),window.addEventListener("scroll",this.#w,{passive:!0}),this.#d=new ResizeObserver(this.#O),this.#d.observe(this),this.#c=this.querySelector(".photo-layout-toggle"),this.#c?.addEventListener("click",this.#L),this.#t?.addEventListener("keydown",this.#I))}disconnectedCallback(){window.removeEventListener("scroll",this.#w),this.#d&&(this.#d.disconnect(),this.#d=null),this.#a&&(clearTimeout(this.#a),this.#a=null),this.#c&&(this.#c.removeEventListener("click",this.#L),this.#c=null),this.#t&&(this.#t.removeEventListener("keydown",this.#I),this.#t=null),this.#y=!1}#A=async()=>{try{const t=await fetch(`/photos/photos.${this.dataset.hash}.json`),[e,i]=await t.json();this.#f=i}catch(t){console.error("[PhotoView] fetch error:",t)}};#T=()=>{localStorage.getItem("photo-layout")?this.#e=localStorage.getItem("photo-layout")==="masonry":(this.#e=this.dataset.layout==="masonry",localStorage.setItem("photo-layout",this.#e?"masonry":"square")),this.dataset.layout=this.#e?"masonry":"square"};#b=()=>{this.#e?(this.#P(),this.#S(),this.#o=!1):(this.#k(),this.#v(),this.#o=!1)};#P=()=>{this.#p=this.offsetWidth,this.#h=Math.floor(this.#p/this.#x),this.#h=Math.max(1,Math.min(this.#h,this.#f.length));const t=this.#r*(this.#h-1);this.#s=(this.#p-t)/this.#h,this.#s=Math.min(this.#s,this.#C),this.#t?.style.setProperty("--photo-width",`${this.#s}px`),this.#i=new Array(this.#h).fill(0)};#E=t=>{const e=this.#M==="sequential"?t%this.#h:this.#i.indexOf(Math.min(...this.#i)),i=this.#i[e],a=e*(this.#s+this.#r);return{col:e,left:a,top:i}};#S=()=>{const t=this.#l*this.#u,e=t+this.#u,i=this.#f.slice(t,e);if(i.length===0){this.#o=!1,this.#m=!0;return}const a=document.createDocumentFragment();let n=t;for(const s of i){const o=s.aspectRatio,r=this.#s/o,{col:d,left:u,top:p}=this.#E(n),h=document.createElement("figure");h.className="photo-figure",h.dataset.aspectRatio=o.toString(),h.setAttribute("role","button"),h.setAttribute("tabindex","0"),h.setAttribute("aria-label","Open viewer"),h.style.setProperty("--photo-top",p.toString()+"px"),h.style.setProperty("--photo-left",u.toString()+"px"),h.style.setProperty("--photo-height",`${r}px`),h.style.setProperty("--photo-placeholder",`url(${s.placeholder})`);const l=document.createElement("img");if(l.src=s.thumbnail,l.alt=s.desc,l.dataset.origin=s.src,l.addEventListener("load",function(){this.style.setProperty("--photo-opacity","1")},{once:!0}),h.appendChild(l),s.desc){const c=document.createElement("figcaption");c.textContent=s.desc,c.setAttribute("aria-hidden","true"),h.appendChild(c)}this.#i[d]+=this.#s/o+this.#r,a.appendChild(h),n++}this.#n&&(this.#n.style.display="none"),this.style.height=`${Math.max(...this.#i)}px`,this.#t?.appendChild(a),this.#l++};#k=()=>{this.#t?.style.setProperty("--min-photo-width",`${this.#x}px`),this.#t?.style.setProperty("--photo-gap",`${this.#r}px`)};#v=()=>{const t=this.#l*this.#u,e=t+this.#u,i=this.#f.slice(t,e);if(i.length===0){this.#o=!1,this.#m=!0;return}const a=document.createDocumentFragment();for(const n of i){const s=document.createElement("figure");s.className="photo-figure",s.setAttribute("role","button"),s.setAttribute("tabindex","0"),s.setAttribute("aria-label","Open viewer"),s.style.setProperty("--photo-placeholder",`url(${n.placeholder})`);const o=document.createElement("img");if(o.src=n.thumbnail,o.alt=n.desc,o.dataset.origin=n.src,o.addEventListener("load",function(){this.style.opacity="1"},{once:!0}),s.appendChild(o),n.desc){const r=document.createElement("figcaption");r.textContent=n.desc,r.setAttribute("aria-hidden","true"),s.appendChild(r)}a.appendChild(s)}this.#n&&(this.#n.style.display="none"),this.#t?.appendChild(a),this.#l++};#$=()=>{if(this.#p===this.offsetWidth)return;this.#P();const t=Array.from(this.querySelectorAll(".photo-figure"));for(let e=0;e<t.length;e++){const i=t[e],{col:a,left:n,top:s}=this.#E(e),o=parseFloat(i.dataset.aspectRatio);i.style.setProperty("--photo-left",n.toString()+"px"),i.style.setProperty("--photo-top",s.toString()+"px"),i.style.setProperty("--photo-height",`${this.#s/o}px`),this.#i[a]+=this.#s/o+this.#r}this.style.height=`${Math.max(...this.#i)}px`};#H=()=>{const t=window.pageYOffset||document.documentElement.scrollTop,e=window.innerHeight;document.documentElement.scrollHeight-(t+e)<=this.#q&&(this.#o=!0,this.#e?this.#S():this.#v(),this.#o=!1)};#w=()=>{!this.#g&&!this.#o&&!this.#m&&(requestAnimationFrame(()=>{this.#H(),this.#g=!1}),this.#g=!0)};#W=()=>{this.#a&&clearTimeout(this.#a),this.#a=setTimeout(()=>this.#$(),100)};#O=()=>{this.#e&&this.#W()};#L=()=>{this.#t&&(this.#t.innerHTML="",this.#t.style=""),this.#n&&(this.#n.style.display=""),this.#e=!this.#e,this.dataset.layout=this.#e?"masonry":"square",this.style.height=this.#e?"0":"auto",this.#l=0,this.#o=!0,this.#m=!1,this.#b(),window.localStorage.setItem("photo-layout",this.#e?"masonry":"square")};#I=t=>{if(t.defaultPrevented||t.key!=="Enter")return;const e=t.target?.closest(".photo-figure");if(!e)return;e.querySelector("img")?.click()}}customElements.get("photo-view")||customElements.define("photo-view",m);
